from typing import List

import regex
import unicodedata

_REGEX_GRAPHEME = regex.compile(r'\X', flags=regex.UNICODE)
_REGEX_WORD_CHAR = regex.compile(r'\w', flags=regex.UNICODE)

#
_ASCII_ALIKE = {'A': 'Ã€ÃÃ‚ÃƒÃ„Ã…Ä€Ä‚Ä„ÇÇžÇ ÇºÈ€È‚È¦ÈºÎ†Î‘á´€á´¬á¸€áº áº¢áº¤áº¦áº¨áºªáº¬áº®áº°áº²áº´áº¶á¼ˆá¼‰á¼Šá¼‹á¼Œá¼á¼Žá¼á¾ˆá¾‰á¾Šá¾‹á¾Œá¾á¾Žá¾á¾¸á¾¹á¾ºá¾»á¾¼â±¯ï¼¡ð€ð´ð‘¨ð’œð“ð”„ð”¸ð•¬ð– ð—”ð˜ˆð˜¼ð™°',
                'B': 'ÆÆ‚ÉƒÊ™Î’á´ƒá´®á´¯á¸‚á¸„á¸†â„¬ï¼¢ððµð‘©ð“‘ð”…ð”¹ð•­ð–¡ð—•ð˜‰ð˜½ð™±',
                'C': 'Ã‡Ä†ÄˆÄŠÄŒÆ‡È»Ê—á´„á¸ˆâ„‚â„­ï¼£ð‚ð¶ð‘ªð’žð“’ð•®ð–¢ð—–ð˜Šð˜¾ð™²',
                'D': 'ÃÄŽÄÆ‰ÆŠÆ‹Î”á´…á´†á´°á¸Šá¸Œá¸Žá¸á¸’â……ï¼¤ðƒð·ð‘«ð’Ÿð““ð”‡ð”»ð•¯ð–£ð——ð˜‹ð˜¿ð™³',
                'E': 'ÃˆÃ‰ÃŠÃ‹Ä’Ä”Ä–Ä˜ÄšÆÈ„È†È¨É†ÊšÎˆÎ‰Î•Î—á´‡á´±á´²á¸”á¸–á¸˜á¸šá¸œáº¸áººáº¼áº¾á»€á»‚á»„á»†á¼˜á¼™á¼šá¼›á¼œá¼á¼¨á¼©á¼ªá¼«á¼¬á¼­á¼®á¼¯á¾˜á¾™á¾šá¾›á¾œá¾á¾žá¾Ÿá¿ˆá¿‰á¿Šá¿‹á¿Œâ„°ï¼¥ð„ð¸ð‘¬ð“”ð”ˆð”¼ð•°ð–¤ð—˜ð˜Œð™€ð™´',
                'F': 'Æ‘É¸á¸žâ„±ï¼¦ð…ð¹ð‘­ð“•ð”‰ð”½ð•±ð–¥ð—™ð˜ð™ð™µ',
                'G': 'ÄœÄžÄ Ä¢Æ“Æ”Ç¤Ç¦Ç´Ê›Ë Î“á´³á¸ ï¼§ð†ðºð‘®ð’¢ð“–ð”Šð”¾ð•²ð–¦ð—šð˜Žð™‚ð™¶',
                'H': 'Ä¤Ä¦ÈžÊœá´´á¸¢á¸¤á¸¦á¸¨á¸ªâ„‹â„Œâ„â±§ï¼¨ð‡ð»ð‘¯ð“—ð•³ð–§ð—›ð˜ð™ƒð™·',
                'I': 'ÃŒÃÃŽÃÄ¨ÄªÄ¬Ä®Ä°Æ–Æ—ÇÈˆÈŠÉªÎŠÎÎ™Îªá´µá¸¬á¸®á»ˆá»Šá¼¸á¼¹á¼ºá¼»á¼¼á¼½á¼¾á¼¿á¿˜á¿™á¿šá¿›â„â„‘ï¼©ðˆð¼ð‘°ð“˜ð•€ð•´ð–¨ð—œð˜ð™„ð™¸',
                'J': 'Ä´Éˆá´Šá´¶ï¼ªð‰ð½ð‘±ð’¥ð“™ð”ð•ð•µð–©ð—ð˜‘ð™…ð™¹',
                'K': 'Ä¶Æ˜Ç¨Îšá´‹á´·á¸°á¸²á¸´â±©ï¼«ðŠð¾ð‘²ð’¦ð“šð”Žð•‚ð•¶ð–ªð—žð˜’ð™†ð™º',
                'L': 'Ä¹Ä»Ä½Ä¿ÅÈ½ÊŸÎ›á´Œá´¸á¸¶á¸¸á¸ºá¸¼â„’â± â±¢ï¼¬ð‹ð¿ð‘³ð“›ð”ð•ƒð•·ð–«ð—Ÿð˜“ð™‡ð™»',
                'M': 'Îœá´á´¹á¸¾á¹€á¹‚â„³â±®ï¼­ðŒð‘€ð‘´ð“œð”ð•„ð•¸ð–¬ð— ð˜”ð™ˆð™¼',
                'N': 'Ã‘ÅƒÅ…Å‡ÆÇ¸È Îá´Žá´ºá´»á¹„á¹†á¹ˆá¹Šâ„•ï¼®ðð‘ð‘µð’©ð“ð”‘ð•¹ð–­ð—¡ð˜•ð™‰ð™½',
                'O': 'Ã’Ã“Ã”Ã•Ã–Ã˜ÅŒÅŽÅÆ†ÆŸÆ Ç‘ÇªÇ¬Ç¾ÈŒÈŽÈªÈ¬È®È°É·ÎŒÎÎŸÎ©á´á´‘á´“á´¼á¹Œá¹Žá¹á¹’á»Œá»Žá»á»’á»”á»–á»˜á»šá»œá»žá» á»¢á½ˆá½‰á½Šá½‹á½Œá½á½¨á½©á½ªá½«á½¬á½­á½®á½¯á¾¨á¾©á¾ªá¾«á¾¬á¾­á¾®á¾¯á¿¸á¿¹á¿ºá¿»á¿¼ï¼¯ðŽð‘‚ð‘¶ð’ªð“žð”’ð•†ð•ºð–®ð—¢ð˜–ð™Šð™¾',
                'P': 'Æ¤Î á´˜á´¾á¹”á¹–â„™â±£ï¼°ðð‘ƒð‘·ð’«ð“Ÿð”“ð•»ð–¯ð—£ð˜—ð™‹ð™¿',
                'Q': 'Ïžâ„šï¼±ðð‘„ð‘¸ð’¬ð“ ð””ð•¼ð–°ð—¤ð˜˜ð™Œðš€',
                'R': 'Å”Å–Å˜ÈÈ’ÉŒÊ€ÊÎ¡á´™á´šá´¿á¹˜á¹šá¹œá¹žá¿¤á¿¥á¿¬â„›â„œâ„â±¤ï¼²ð‘ð‘…ð‘¹ð“¡ð•½ð–±ð—¥ð˜™ð™ðš',
                'S': 'ÅšÅœÅžÅ È˜ÊƒÊ…Ê†Î£á¹ á¹¢á¹¤á¹¦á¹¨áº›ï¼³ð’ð‘†ð‘ºð’®ð“¢ð”–ð•Šð•¾ð–²ð—¦ð˜šð™Žðš‚',
                'T': 'Å¢Å¤Å¦Æ¬Æ®ÈšÈ¾Î¤á´›áµ€á¹ªá¹¬á¹®á¹°ï¼´ð“ð‘‡ð‘»ð’¯ð“£ð”—ð•‹ð•¿ð–³ð—§ð˜›ð™ðšƒ',
                'U': 'Ã™ÃšÃ›ÃœÅ¨ÅªÅ¬Å®Å°Å²Æ¯Ç“Ç•Ç—Ç™Ç›È”È–É„ÊŠÎŽÎ¥Î«Ï’Ï“Ï”á´œáµá¹²á¹´á¹¶á¹¸á¹ºá»¤á»¦á»¨á»ªá»¬á»®á»°á½™á½›á½á½Ÿá¿¨á¿©á¿ªá¿«ï¼µð”ð‘ˆð‘¼ð’°ð“¤ð”˜ð•Œð–€ð–´ð—¨ð˜œð™ðš„',
                'V': 'Æ²Ë¬á´ á¹¼á¹¾ï¼¶ð•ð‘‰ð‘½ð’±ð“¥ð”™ð•ð–ð–µð—©ð˜ð™‘ðš…',
                'W': 'Å´ÆœÇ·É¯É°Ïœá´¡áµ‚áº€áº‚áº„áº†áºˆï¼·ð–ð‘Šð‘¾ð’²ð“¦ð”šð•Žð–‚ð–¶ð—ªð˜žð™’ðš†',
                'X': 'áºŠáºŒï¼¸ð—ð‘‹ð‘¿ð’³ð“§ð”›ð•ð–ƒð–·ð—«ð˜Ÿð™“ðš‡',
                'Y': 'ÃÅ¶Å¸Æ±Æ³ÈœÈ²ÉŽÉ¥ÊáºŽá»²á»´á»¶á»¸ï¼¹ð˜ð‘Œð’€ð’´ð“¨ð”œð•ð–„ð–¸ð—¬ð˜ ð™”ðšˆ',
                'Z': 'Å¹Å»Å½ÆµÈ¤Ê’Ê“Î–á´¢áºáº’áº”â„¤â„¨â±«ï¼ºð™ð‘ð’ð’µð“©ð–…ð–¹ð—­ð˜¡ð™•ðš‰',
                'a': 'Ã Ã¡Ã¢Ã£Ã¤Ã¥ÄÄƒÄ…ÇŽÇŸÇ¡Ç»ÈÈƒÈ§ÉÉ‘É’Î¬Î±áµƒáµ„áµ…á¸áºšáº¡áº£áº¥áº§áº©áº«áº­áº¯áº±áº³áºµáº·á¼€á¼á¼‚á¼ƒá¼„á¼…á¼†á¼‡á½°á½±á¾€á¾á¾‚á¾ƒá¾„á¾…á¾†á¾‡á¾°á¾±á¾²á¾³á¾´á¾¶á¾·â‚â±¥ï½ðšð‘Žð’‚ð’¶ð“ªð”žð•’ð–†ð–ºð—®ð˜¢ð™–ðšŠ',
                'b': 'Æ€ÆƒÉ“Î²Ïáµ‡áµáµ¦áµ¬á¶€á¸ƒá¸…á¸‡ï½‚ð›ð‘ð’ƒð’·ð“«ð”Ÿð•“ð–‡ð–»ð—¯ð˜£ð™—ðš‹',
                'c': 'Ã§Ä‡Ä‰Ä‹ÄÆˆÈ¼É•Ï²á¸‰ï½ƒðœð‘ð’„ð’¸ð“¬ð” ð•”ð–ˆð–¼ð—°ð˜¤ð™˜ðšŒ',
                'd': 'Ã°ÄÄ‘ÆŒÆÈ¡É–É—Î´áµˆáµŸáµ­á¶á¸‹á¸á¸á¸‘á¸“â…†ï½„ðð‘‘ð’…ð’¹ð“­ð”¡ð••ð–‰ð–½ð—±ð˜¥ð™™ðš',
                'e': 'Ã¨Ã©ÃªÃ«Ä“Ä•Ä—Ä™Ä›È…È‡È©É‡É˜É›ÉœÉÉžÎ­Î®ÎµÎ·á´ˆáµ‰áµ‹áµŒá¸•á¸—á¸™á¸›á¸áº¹áº»áº½áº¿á»á»ƒá»…á»‡á¼á¼‘á¼’á¼“á¼”á¼•á¼ á¼¡á¼¢á¼£á¼¤á¼¥á¼¦á¼§á½²á½³á½´á½µá¾á¾‘á¾’á¾“á¾”á¾•á¾–á¾—á¿‚á¿ƒá¿„á¿†á¿‡â‚‘â„¯â…‡ï½…ðžð‘’ð’†ð“®ð”¢ð•–ð–Šð–¾ð—²ð˜¦ð™šðšŽ',
                'f': 'Æ’áµ áµ©áµ®á¶‚á¸Ÿï½†ðŸð‘“ð’‡ð’»ð“¯ð”£ð•—ð–‹ð–¿ð—³ð˜§ð™›ðš',
                'g': 'ÄÄŸÄ¡Ä£Ç¥Ç§ÇµÉ É¡É¢É£Î³áµáµžáµ§áµ·á¶ƒá¸¡â„Šï½‡ð ð‘”ð’ˆð“°ð”¤ð•˜ð–Œð—€ð—´ð˜¨ð™œðš',
                'h': 'Ä¥Ä§ÈŸÉ¦É§Ê®Ê¯Ê°Ê±á¸£á¸¥á¸§á¸©á¸«áº–â‚•â±¨ï½ˆð¡ð’‰ð’½ð“±ð”¥ð•™ð–ð—ð—µð˜©ð™ðš‘',
                'i': 'Ã¬Ã­Ã®Ã¯Ä©Ä«Ä­Ä¯Ä±ÇÈ‰È‹É¨É©Î¯Î¹ÏŠá´‰áµŽáµ¢á¸­á¸¯á»‰á»‹á¼°á¼±á¼²á¼³á¼´á¼µá¼¶á¼·á½¶á½·á¾¾á¿á¿‘á¿’á¿“á¿–á¿—â±â…ˆï½‰ð¢ð‘–ð’Šð’¾ð“²ð”¦ð•šð–Žð—‚ð—¶ð˜ªð™žðš’ðš¤',
                'j': 'ÄµÇ°È·É‰ÉŸÊ„ÊÊ²Ï³â…‰ï½Šð£ð‘—ð’‹ð’¿ð“³ð”§ð•›ð–ð—ƒð—·ð˜«ð™Ÿðš“ðš¥',
                'k': 'Ä·Ä¸Æ™Ç©ÊžÎºÏ°áµá¶„á¸±á¸³á¸µâ‚–â±ªï½‹ð¤ð‘˜ð’Œð“€ð“´ð”¨ð•œð–ð—„ð—¸ð˜¬ð™ ðš”',
                'l': 'ÄºÄ¼Ä¾Å€Å‚ÆšÆ›È´É«É¬É­Ë¡Î»á¶…á¸·á¸¹á¸»á¸½â‚—â„“â±¡ï½Œð¥ð‘™ð’ð“ð“µð”©ð•ð–‘ð—…ð—¹ð˜­ð™¡ðš•',
                'm': 'É±Î¼á´Ÿáµáµšáµ¯á¶†á¸¿á¹á¹ƒâ‚˜ï½ð¦ð‘šð’Žð“‚ð“¶ð”ªð•žð–’ð—†ð—ºð˜®ð™¢ðš–',
                'n': 'Ã±Å„Å†ÅˆÆžÇ¹ÈµÉ²É³É´Î½áµ°á¶‡á¹…á¹‡á¹‰á¹‹â¿â‚™ï½Žð§ð‘›ð’ð“ƒð“·ð”«ð•Ÿð–“ð—‡ð—»ð˜¯ð™£ðš—',
                'o': 'Ã²Ã³Ã´ÃµÃ¶Ã¸ÅÅÅ‘Æ¡Ç’Ç«Ç­Ç¿ÈÈÈ«È­È¯È±É”ÉµÎ¿Ï‰ÏŒÏŽáµ’á¹á¹á¹‘á¹“á»á»á»‘á»“á»•á»—á»™á»›á»á»Ÿá»¡á»£á½€á½á½‚á½ƒá½„á½…á½ á½¡á½¢á½£á½¤á½¥á½¦á½§á½¸á½¹á½¼á½½á¾ á¾¡á¾¢á¾£á¾¤á¾¥á¾¦á¾§á¿²á¿³á¿´á¿¶á¿·â‚’â„´ï½ð¨ð‘œð’ð“¸ð”¬ð• ð–”ð—ˆð—¼ð˜°ð™¤ðš˜',
                'p': 'Æ¥Ï€Ï–áµ–áµ±áµ½á¶ˆá¹•á¹—â‚šï½ð©ð‘ð’‘ð“…ð“¹ð”­ð•¡ð–•ð—‰ð—½ð˜±ð™¥ðš™',
                'q': 'ÉŠÉ‹Ê ÏŸï½‘ðªð‘žð’’ð“†ð“ºð”®ð•¢ð––ð—Šð—¾ð˜²ð™¦ðšš',
                'r': 'Å•Å—Å™È‘È“ÉÉ¹ÉºÉ»É¼É½É¾É¿Ê³Ê´ÊµÊ¶ÏÏ±áµ£áµ¨áµ²áµ³á¶‰á¹™á¹›á¹á¹Ÿï½’ð«ð‘Ÿð’“ð“‡ð“»ð”¯ð•£ð–—ð—‹ð—¿ð˜³ð™§ðš›',
                's': 'Å›ÅÅŸÅ¡Å¿È™È¿Ê‚Ë¢Ï‚Ïƒáµ´á¶Šá¹¡á¹£á¹¥á¹§á¹©â‚›ï½“ð¬ð‘ ð’”ð“ˆð“¼ð”°ð•¤ð–˜ð—Œð˜€ð˜´ð™¨ðšœ',
                't': 'Å£Å¥Å§Æ«Æ­È›È¶Ê‡ÊˆÏ„áµ—áµµá¹«á¹­á¹¯á¹±áº—â‚œâ±¦ï½”ð­ð‘¡ð’•ð“‰ð“½ð”±ð•¥ð–™ð—ð˜ð˜µð™©ðš',
                'u': 'Ã¹ÃºÃ»Ã¼Å©Å«Å­Å¯Å±Å³Æ°Ç”Ç–Ç˜ÇšÇœÈ•È—É¤Ê‰Î°Ï…Ï‹Ïá´á´žáµ˜áµ™áµ¤á¹³á¹µá¹·á¹¹á¹»á»¥á»§á»©á»«á»­á»¯á»±á½á½‘á½’á½“á½”á½•á½–á½—á½ºá½»á¿ á¿¡á¿¢á¿£á¿¦á¿§ï½•ð®ð‘¢ð’–ð“Šð“¾ð”²ð•¦ð–šð—Žð˜‚ð˜¶ð™ªðšž',
                'v': 'Ê‹áµ›áµ¥á¶Œá¹½á¹¿ï½–ð¯ð‘£ð’—ð“‹ð“¿ð”³ð•§ð–›ð—ð˜ƒð˜·ð™«ðšŸ',
                'w': 'ÅµÆ¿ÊÊ·Ïáºáºƒáº…áº‡áº‰áº˜ï½—ð°ð‘¤ð’˜ð“Œð”€ð”´ð•¨ð–œð—ð˜„ð˜¸ð™¬ðš ',
                'x': 'Ë£Î¾á¶áº‹áºâ‚“ï½˜ð±ð‘¥ð’™ð“ð”ð”µð•©ð–ð—‘ð˜…ð˜¹ð™­ðš¡',
                'y': 'Ã½Ã¿Å·Æ´ÈÈ³ÉÊŽÊ¸áºáº™á»³á»µá»·á»¹ï½™ð²ð‘¦ð’šð“Žð”‚ð”¶ð•ªð–žð—’ð˜†ð˜ºð™®ðš¢',
                'z': 'ÅºÅ¼Å¾Æ¶È¥É€ÊÊ‘Î¶áµ¶á¶Žáº‘áº“áº•â±¬ï½šð³ð‘§ð’›ð“ð”ƒð”·ð•«ð–Ÿð—“ð˜‡ð˜»ð™¯ðš£',
                }
_ASCII_TRANLATION_LOOKUP = {ord(char): alpha for alpha, chars in _ASCII_ALIKE.items() for char in chars}


def tokenize(text: str,
             nfkd: bool = True,
             casefold: bool = False,
             replace_ascii: bool = False,
             strip_diacritics: bool = False,
             ) -> List[str]:
    """
    tokenize text into words

    :param text: to extract words from
    :param nfkd: unicode normal form canonical decomposition
    :param casefold: lowercase but better
    :param replace_ascii: make ascii-like where possible
    :param strip_diacritics: unwrap graphemes and only keep base char
    :return: list of words
    """

    # sanity check
    if not isinstance(text, str):
        raise TypeError(f'expected <str>, for <{type(text)}>')

    # pre-process step 1: unicode decomposition
    if nfkd:
        text = f'{unicodedata.normalize("NFKD", text)}\0'
    else:
        text += '\0'

    # pre-process step 2: casefold
    if casefold:
        text = text.casefold()

    # pre-process step 3: replace ascii-like chars
    if replace_ascii:
        text = text.translate(_ASCII_TRANLATION_LOOKUP)

    # get all word tokens
    tokens = []
    token_buffer = []
    for match in _REGEX_GRAPHEME.finditer(text):
        grapheme = match.group(0)

        # don't count underscore as a word token, despite what the unicode standard says
        if grapheme[0] not in {'_'}:
            if _REGEX_WORD_CHAR.match(grapheme):
                token_buffer.append(grapheme[0] if strip_diacritics else grapheme)
                continue

        # not a word-like grapheme, append current word
        if token_buffer:
            tokens.append(''.join(token_buffer))
            token_buffer.clear()

    return tokens
